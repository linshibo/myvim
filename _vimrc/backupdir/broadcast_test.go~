package broadcast

import (
    "fmt"
    "testing"
    "time"
    "sync"
)

var b = NewBroadcaster()

var id int = 0
var lock sync.Mutex

func listen(r Receiver) {
    lock.Lock()
    id++
    index:=id
    lock.Unlock()
    fmt.Println(index, " start listen")
    for v := r.Read(); v != nil; v = r.Read() {
        go listen(r)
        //t.Log(v)
        fmt.Println(index,"read", v)
    }
}

func TestBroadCast(t *testing.T) {
    r := b.Listen()
    go listen(r)
    for i := 0; i < 5; i++ {
        fmt.Println("write ", i)
        b.Write(i)
    }
    b.Write(nil)

    time.Sleep(5 * 1e9)
    t.Log("测试通过")
}
