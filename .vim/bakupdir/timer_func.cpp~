/*
 * =========================================================================
 *
 *        Filename: timer_func.cpp
 *
 *        Version:  1.0
 *        Created:  2011-05-17 10:40:29
 *        Description:  
 *
 *        Author:  jim (jim@taomee.com)
 *        Company:  TAOMEE
 *
 * =========================================================================
 */

#include    "timer_func.h"
#include    "svr_proto.h"
#include    "cli_proto.h"
#ifdef __cplusplus
extern "C"
{
#endif
#include <libtaomee/conf_parser/config.h>
#include <libtaomee/inet/tcp.h>
#include <async_serv/net_if.h>
#include <async_serv/dll.h>
#ifdef __cplusplus
}
#endif



void user_time_test(uint32_t key, void*data,int data_len)
{
	Csprite * p=g_sprite_map->get_sprite(key);	
	if (p){
		KDEBUG_LOG(key,"user_time_test_cmd ok  ");
	}else{
		DEBUG_LOG("ERROR no find cache buf userid=%u",key );
	}
	g_timer_map->add_timer(time(NULL)+60 , n_user_time_test,key );
}


void deal_cahce_cmd(uint32_t key, void*data,int data_len)
{
	DEBUG_LOG("deal_cahce_cmd");
	Csprite * p=g_sprite_map->get_sprite(key);	
	if (p){
		char * data=p->cache_buffer_lst.get_first_buffer();
		if ( data  ) {
			dispatch(data,p->fdsess,false );
			p->cache_buffer_lst.pop_front();
		}
	}else{
		DEBUG_LOG("ERROR no find cache buf userid=%u",key );
	}
}




void init_timer_funcs()
{
#define ADD_TIMER_FUNC( func_name ) \
	g_timer_map->add_function(n_##func_name,func_name);
	ADD_TIMER_FUNC(deal_cahce_cmd);
	ADD_TIMER_FUNC(user_time_test );
}

