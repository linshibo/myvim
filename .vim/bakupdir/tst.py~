#!/usr/bin/env python
# -*- coding: utf-8 -*-
import proto_base 
import time 
import mypub 
import struct 
def print_err(msg):
    print "\033[1m\033[41m%s\033[0m"%msg
def print_succ(msg):
    print "\033[1m\033[42m%s\033[0m"%msg


class Dealmsg: 
	def __init__(self):
		pass


	def dealmsg(self,cmdid,userid,result,primsg):
		if ultraman_online_proto.cmd_map.has_key(cmdid):
			#得到类名
			classname=ultraman_online_proto.cmd_map[cmdid][3];

			if classname <> None:	
				pri_out=classname() ;
			else:
				pri_out=proto_base.Cmessage();
			
			ba=proto_base.Cbyte_array();
			ba.set_is_big_endian(True);
			ba.init_read_mode(primsg);
			if (result==0 ):
				ret=pri_out.read_from_buf(ba);
				if ( not  ret ):
					print "解析出错:报文不够",classname;
				if (ba.get_left_len() >0 ):
					print "解析出错:有剩余报文";
					mypub.print_hex_16(primsg[ba.get_postion():] );
			

			try:
				#得到调用函数
 				cmd_name=ultraman_online_proto.cmd_map[cmdid][1];
				func_name='do_%s'%( cmd_name ) 
				print func_name
				func = getattr(self , func_name  )
				func(result,primsg);
			except AttributeError:
				print "deal: userid=%d, %s[%d] : "%(userid,cmd_name , cmdid )
				pri_out.echo(True, "    ");
				pass
			return pri_out;
		else:
			print "未处理:", cmdid, result
			mypub.print_hex_16(primsg)


dm=Dealmsg()

def get_msg_return(need_cmdid,asnyc_flag=False):
	global p
	global dm 
	start_time=time.clock();
	while True:
		out_info=p.getrecvmsg();
		if (out_info):
			proto_len ,cmdid,   userid, seq, result,pri_msg=out_info;
			if cmdid==1001:
				p.set_seq(seq);
			if result==0:
				print_succ( ">>>>OUT:cmdid: %d ret: %d  seq: %d len: %d"%(cmdid,result,seq,proto_len ) )  ;
				pri_out=dm.dealmsg(cmdid,userid,result,pri_msg );
			else:
				print_err( ">>>>ERROR:cmdid: %d ret: %d  seq: %d len: %d"%(cmdid,result,seq,proto_len ) )  ;
	
			if (cmdid==need_cmdid):
				return pri_out; 

		end_time=time.clock();
		if asnyc_flag and end_time-start_time>1:#是异步的
		  	return False;

import sys

userid=50067
if len(sys.argv)>=2:
	userid=int(sys.argv[1] )

onlineid=1
#ip,port,key=login_proto.login("10.1.1.46", 8989,onlineid ,userid, "142857" )
#print "userid:",userid , " login online:" ,ip,port
ip="10.1.1.20"
port=6009
import ultraman_online_proto
p=ultraman_online_proto.Cultraman_online_proto(ip,port);
p.set_is_big_endian(True);
p.set_userid(userid);
p.cli_login(0,"","",1353618797);
get_msg_return(1001,False);
user=ultraman_online_proto.uid_role_t()
user.user_id=50066
user.role_tm=1354635437
#p.cli_add_friend(user);
#p.cli_del_friend(user)
#p.cli_del_from_blacklist(user)
#p.cli_add_to_blacklist(user)
#p.cli_set_user_flag(1,1)
#get_msg_return(1008, False);
#idlist=[user]
#p.cli_check_online_users(idlist)
#get_msg_return(1013, False);
#p.cli_get_user_info(user)
#get_msg_return(1015, False);
p.cli_proto_enter_map(10,100,100);
get_msg_return(1020, False);
print "hello"

import time 
#i=0;
#msglist=["sdfasdfadll","11111111l","323333333"]
#while True:
	#msg= msglist[i%3] 
	#p.cli_talk(0,msg );
	#p.cli_buy_skill(1111,3355 );
	##p.cli_user_walk(300 );
	#print msg;
	#get_msg_return(0, True);
	#i+=1
	#time.sleep( 1);

get_msg_return(0, False);
