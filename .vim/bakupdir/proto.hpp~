/** 
 * ========================================================================
 * @file proto.hpp
 * @brief 
 * @version 1.0
 * @date 2011-12-26
 * Modify $Date: 2012-08-30 23:30:15 -0400 (Thu, 30 Aug 2012) $
 * Modify $Author: singku $
 * Copyright: TaoMee, Inc. ShangHai CN. All rights reserved.
 * ========================================================================
 */


#ifndef H_PROTO_H_2011_12_26
#define H_PROTO_H_2011_12_26


extern "C" {
#include <assert.h>
#include <glib.h>

#include <async_serv/net_if.h>
#include <libtaomee/utils.h>
}

#include <map>
#include <libtaomee++/proto/proto_util.h>

class player_t;

/////////////////////////////////////////////////////////////////////////

#define DEFAULT_ARG     \
    player_t * p, Cmessage * c_in, Cmessage * c_out, void * param

#define PROTO_IN(c_in)  (dynamic_cast<typeof p_out>(c_in))
#define PROTO_OUT(c_out)  (dynamic_cast<typeof p_out>(c_out))
//-------------------------------------------------------
////函数定义
#ifdef PROTO_FUNC_DEF
#undef PROTO_FUNC_DEF
#endif

#define PROTO_FUNC_DEF(proto_name)  \
    int proto_name(DEFAULT_ARG = NULL);


#include "proto/pea_online_func_def.h"
#include "proto/pea_btlsw_func_def.h"

#undef PROTO_FUNC_DEF
#define PROTO_FUNC_DEF(proto_name) \
     int proto_name ## _callback(DEFAULT_ARG = NULL);
#include "proto/pea_db_func_def.h"
#include "proto/pea_vip_db_func_def.h"
#include "proto/pea_battle_func_def.h"
#undef PROTO_FUNC_DEF


//-------------------------------------------------------------
////对应的结构体
#include "./proto/pea.h"
#include "./proto/pea_online.h"
#include "./proto/pea_btlsw.h"
#include "./proto/pea_battle.h"
#include "./proto/pea_db.h"
#include "./proto/pea_vip_db.h"

//-------------------------------------------------
//命令绑定
typedef int (* deal_func_t)(DEFAULT_ARG);

struct bind_proto_cmd_t
{
    uint32_t cmd;
    deal_func_t func;
    Cmessage * p_in;
    Cmessage * p_out;
    uint32_t  md5_tag; //md5值
    uint32_t  bind_bitmap;

    void combine(const bind_proto_cmd_t * p_cmd)
    {
        if (NULL == func && NULL != p_cmd->func)
        {
            func = p_cmd->func;
        }

        if (NULL == p_in && NULL != p_cmd->p_in)
        {
            p_in = p_cmd->p_in;
        }

        if (NULL == p_out && NULL != p_cmd->p_out)
        {
            p_out = p_cmd->p_out;
        }
    }

};


//////////////////////////////////////////////////////////////
// 错误码，协议号
//////////////////////////////////////////////////////////////

#include "proto/pea_online_enum.h"
#include "proto/pea_btlsw_enum.h"
#include "proto/pea_battle_enum.h"
#include "proto/pea_db_enum.h"
#include "proto/pea_vip_db_enum.h"

//////////////////////////////////////////////////////////////////////////
extern const uint32_t size_of_cli_cmd_list;
extern bind_proto_cmd_t g_cli_cmd_list[];

const bind_proto_cmd_t * find_cli_cmd_bind(uint16_t cmd);

const bind_proto_cmd_t * find_btlsw_cmd_bind(uint16_t cmd);

const bind_proto_cmd_t * find_db_cmd_bind(uint16_t cmd);

const bind_proto_cmd_t * find_vip_db_cmd_bind(uint16_t cmd);

const bind_proto_cmd_t * find_battle_cmd_bind(uint16_t cmd);

// 用于读取网络序包体
bool read_from_buf_n(Cmessage * p_in, const char * buf, uint32_t buf_size);

#endif
