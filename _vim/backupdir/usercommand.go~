package gameserver

import (
	"encoding/json"
	"sanguo/base/log"
	//"sanguo/base/packet"
	"sanguo/db"
)

var CmdHandler map[uint16]func(*Session, []byte) bool

//opcode4
func UserChangeFormation(sess *Session, reader []byte) bool {
	dbconn := db.Pool.Get()
	defer dbconn.Close()

	type Change struct {
		Index int
		Armid int
	}
	type Change_slice struct {
		Formation []Change
	}

	var msg Change_slice

	err := json.Unmarshal(reader, &msg)
	if err != nil {
		log.Error("Can't decode json message, err = %v", err, sess.user.uid)
		return false
	}

	back := map[string]bool{"ret": true}

	for _, change := range msg.Formation {
		armid := change.Armid
		index := change.Index
		if armid < 0 {
			return false
		}

		if index < 0 {
			return false
		}

		if index > (FormationLength - 1) {
			return false
		}

		sess.user.Arm.formation[index] = armid

		_, err = dbconn.Do("LSET", sess.user.GetUidUsedInDB()+":formation", index, armid)
		if err != nil {
			log.Error("Sth wrong with database in the change of formation of player:", sess.user.uid)
			return false
		}
	}

	return sess.SendReplyBack(back, 4)
}

func init() {
	CmdHandler = make(map[uint16]func(*Session, []byte) bool)
	CmdHandler[1] = UserLogin_
	CmdHandler[2] = UserLogin_
	//CmdHandler[3] = UserMerge
	CmdHandler[4] = UserChangeFormation
	CmdHandler[5] = UserStartFight
	CmdHandler[6] = UserEndFight
	//CmdHandler[8] = UserIsGidExist

	CmdHandler[9] = UserCardUpdateByStone
	CmdHandler[10] = UserCardAdvanceByStone

	CmdHandler[11] = UserUnlockQuest
	CmdHandler[12] = UserGetQuestReward
	CmdHandler[14] = UserNewTopic
	CmdHandler[15] = UserNewComment
	CmdHandler[16] = UserGetTopic
	CmdHandler[17] = UserReadTropic
	CmdHandler[18] = UserUnreadTropic
	CmdHandler[20] = UserGetScoreOfSimpleGuanqia

	CmdHandler[20] = UserSendUnreward
	CmdHandler[22] = UserGetUnreward

	CmdHandler[25] = UserGetRandomCard
	CmdHandler[26] = UserGetRandomCard_Continue
	CmdHandler[27] = UserRecruitArm
	CmdHandler[28] = UserBuyCard

	CmdHandler[31] = UserGetLoginReward
	CmdHandler[33] = UserGetLoginArm
	CmdHandler[34] = UserGetExtraArm
	CmdHandler[35] = UserGetStoneThroughArmEveryday
	CmdHandler[41] = HaveSeenNewArm
	CmdHandler[42] = HaveSeenNewHero

	CmdHandler[50] = UserOpenBossFight
	CmdHandler[51] = UserStartBossFight
	CmdHandler[52] = UserWinBossFight
	CmdHandler[53] = UserGetBossRank
	CmdHandler[54] = UserGetTrueHeroRank
	CmdHandler[56] = UserGetSystemUnreward
	CmdHandler[60] = UserApplyFriend
	CmdHandler[62] = UserAcceptOtherAsYourFriend
	CmdHandler[63] = UserDelFriend
	CmdHandler[65] = UserSendMsgToFriend
	CmdHandler[67] = UserGetFriendList
	CmdHandler[69] = UserGetAddFriendReward
	CmdHandler[70] = UserRefreshActivity
	CmdHandler[71] = UserStartActivityFight
	CmdHandler[72] = UserEndActivityFight
	CmdHandler[75] = UserShowOff

	CmdHandler[81] = UserChangeUserInfo
	CmdHandler[82] = UnlockChapter
	CmdHandler[86] = UserGetRank
	CmdHandler[87] = UserGetUserInfo

	CmdHandler[90] = UserBuyPower
	CmdHandler[91] = UserReduceGold
	CmdHandler[92] = UserReduceGold___
	CmdHandler[101] = UserVerifyReceipt
	CmdHandler[102] = UserDiaoChaPie
	CmdHandler[103] = UserInvitationCode
	CmdHandler[105] = UserSignUp
	CmdHandler[107] = UserGetBoxReward
	CmdHandler[108] = UserInitArm
	CmdHandler[110] = UserBorrowArm
	CmdHandler[111] = UserSendArm
	CmdHandler[113] = UserCheckUserInfo
	CmdHandler[121] = UserVerifyReceipt_91
	CmdHandler[130] = UserSetMainHero
	CmdHandler[131] = UserSetArmEquip
	CmdHandler[132] = UserSetConveneBoss
	CmdHandler[133] = UserSetHeroOfTimeLine
	CmdHandler[134] = UserGetPKRank
	CmdHandler[135] = UserStartPk
	CmdHandler[136] = UserFinishPk
	CmdHandler[137] = UserGetPKShop
	CmdHandler[138] = UserExchangePKScore  
}
